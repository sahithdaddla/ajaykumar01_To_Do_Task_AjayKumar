<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Task Allocation - HRMS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            margin: 0;
            padding: 20px;
            color: #000000;
            /* background-color: #f5f5f5; */
        }
        header {
            position: relative;
            text-align: center;
            height: 120px;
            background: linear-gradient(rgb(10, 10, 255),rgb(203, 11, 242));
            color: #fff;
            border-radius: 15px;
            overflow: hidden;
            display: flex;
            width: 98%;
            margin: 0 auto 20px auto;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-family: 'Verdana', sans-serif;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        header h1 {
            margin: 0;
            font-size: 36px;
            color: white;
            font-weight: 600;
            letter-spacing: 2px;
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        header p {
            color: white;
            font-weight: 100;
            font-size: 18px;
            margin-top: 10px;
            opacity: 0.9;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        @keyframes moveCircles {
            0% { transform: translateY(0) translateX(0); }
            50% { transform: translateY(-50%) translateX(-50%); }
            100% { transform: translateY(0) translateX(0); }
        }
        .banner-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            overflow: hidden;
        }
        .circle {
            position: absolute;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: moveCircles 10s infinite linear;
        }
        .circle:nth-child(1) {
            top: 10%;
            left: 20%;
            animation-duration: 8s;
        }
        .circle:nth-child(2) {
            top: 50%;
            left: 70%;
            animation-duration: 12s;
        }
        .circle:nth-child(3) {
            top: 80%;
            left: 40%;
            animation-duration: 15s;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        .top-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        .search-group {
            display: flex;
            gap: 1rem;
            flex-grow: 1;
            align-items: center;
        }
        .form-label {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #000000;
        }
        .form-control {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        .form-control#searchInput {
            padding: 0.9rem 1.5rem 0.9rem 2.5rem;
            border-radius: 20px;
            background: linear-gradient(to right, #f0f4ff, #e6f0fa);
            border: 1px solid #ccc;
            position: relative;
            transition: all 0.3s;
        }
        .form-control#searchInput::before {
            content: 'üîç';
            position: absolute;
            left: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
            color: #6e48aa;
        }
        .form-control#searchInput::placeholder {
            color: #6e48aa;
            opacity: 0.7;
        }
        .form-control#searchInput:focus {
            outline: none;
            border: 2px solid #150389;
            box-shadow: 0 0 8px rgba(21, 3, 137, 0.3);
        }
        .form-control#searchInput:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .form-control:focus {
            outline: none;
            border-color: #150389;
        }
        .toggle-form-btn {
            display: inline-block;
            padding: 0.8rem 1.5rem;
            background: linear-gradient(135deg, #2724d8 0%, #509ebb 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.3rem;
            justify-content: center;
            white-space: nowrap;
        }
        .toggle-form-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .task-form {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
        }
        .task-form.hidden {
            display: none;
        }
        .form-title {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #3a0098;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        textarea.form-control {
            resize: none;
            min-height: 100px;
        }
        .error-message {
            color: #d32f2f;
            font-size: 0.8rem;
            margin-top: 0.2rem;
            display: none;
            align-items: center;
            gap: 0.3rem;
        }
        .submit-btn {
            display: block;
            width: 100%;
            padding: 0.8rem 1.5rem;
            background: linear-gradient(135deg, #2724d8 0%, #509ebb 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.3rem;
            justify-content: center;
        }
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }
        .panel-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: #3a0098;
        }
        .task-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1rem;
        }
        .task-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            /* border-left: 4px solid #6b19f0; */
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .employee-info {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        .employee-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e0e7ff;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4361ee;
            font-weight: 600;
            margin-right: 12px;
        }
        .employee-name {
            font-weight: 600;
            margin-bottom: 2px;
        }
        .employee-id {
            font-size: 0.8rem;
            color: #6e48aa;
        }
        .employee-email {
            font-size: 0.8rem;
            color: #6e48aa;
            word-break: break-all;
        }
        .task-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #000000;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .task-description {
            color: #6e48aa;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            resize: none;
            border: none;
            width: 100%;
            background: transparent;
            line-height: 1.5;
        }
        .task-dates {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #000000;
        }
        .date-item {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .task-actions {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 0.8rem 1.5rem;
            background: linear-gradient(135deg, #2724d8 0%, #509ebb 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.3rem;
            justify-content: center;
            flex: 1;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .btn-outline {
            background: white;
            color: #2724d8;
            border: 1px solid #2724d8;
        }
        .btn-outline:hover {
            background-color: #e0e7ff;
        }
        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .status-assigned {
            /* background: #e0e7ff; */
            color: #4361ee;
        }
        .status-inprocess {
            background: #e5f6ff;
            color: #0077ff;
            width: 120px;
        }
        .status-completed {
            background: #e5ffe7;
            color: #00aa33;
            width: 120px;
        }
        .work-history-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        .work-history-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            /* border-left: 4px solid #6b19f0; */
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .work-history-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .task-info p {
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .no-file {
            color: #6e48aa;
            font-size: 0.9rem;
        }
        .empty-state {
            text-align: center;
            padding: 3rem 0;
            color: #777;
            grid-column: 1 / -1;
        }
        .empty-state img {
            width: 120px;
            opacity: 0.7;
            margin-bottom: 1rem;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #3a0098;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #777;
        }
        .modal-close:hover {
            color: #d32f2f;
        }
        .modal-content p {
            font-size: 0.9rem;
            margin-bottom: 1rem;
            color: #444;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .modal-content p strong {
            color: #000000;
        }
        @media (max-width: 1024px) {
            .task-grid,
            .work-history-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
            .top-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .search-group {
                margin-bottom: 10px;
            }
            .form-control#searchInput {
                padding: 0.7rem 1rem 0.7rem 2rem;
                font-size: 0.9rem;
            }
            .form-control#searchInput::before {
                left: 0.6rem;
                font-size: 0.9rem;
            }
            .toggle-form-btn {
                width: 100%;
            }
            header h1 {
                font-size: 2rem;
            }
            header p {
                font-size: 1rem;
            }
            .panel {
                padding: 1rem;
            }
            .panel-title {
                font-size: 1.3rem;
            }
            .task-card,
            .work-history-card {
                padding: 1rem;
            }
            .task-title {
                font-size: 1.1rem;
            }
            .task-dates {
                flex-direction: column;
                gap: 0.5rem;
            }
            .task-actions {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
            .modal-content {
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="banner-background">
            <div class="circle"></div>
            <div class="circle"></div>
            <div class="circle"></div>
        </div>
        <h1>üìã Task Allocation</h1>
        <p>üåü Assign and manage employee tasks</p>
    </header>

    <div class="container">
        <!-- Main Content -->
        <div class="main-content">
            <!-- Search and Allocate Button Row -->
            <div class="top-controls">
                <div class="search-group">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search tasks, names, IDs, or emails..." aria-label="Search tasks">
                    <button class="toggle-form-btn" id="toggleFormBtn">üìã Allocate New Task</button>
                </div>
            </div>

            <!-- Task Allocation Form -->
            <div class="task-form hidden" id="taskFormContainer">
                <h2 class="form-title">üì§ Allocate New Task</h2>
                <form id="taskForm" novalidate>
                    <div class="form-group">
                        <label for="taskName" class="form-label">üìù Task Name</label>
                        <input type="text" id="taskName" class="form-control" required placeholder="Enter task name" minlength="3" maxlength="40">
                        <span id="taskNameError" class="error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="employeeName" class="form-label">üë§ Employee Name</label>
                        <input type="text" id="employeeName" class="form-control" required placeholder="Enter employee name" minlength="3" maxlength="100">
                        <span id="employeeNameError" class="error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="employeeId" class="form-label">üÜî Employee ID</label>
                        <input type="text" id="employeeId" class="form-control" required placeholder="Format: ATS0XXX" minlength="7" maxlength="7">
                        <span id="employeeIdError" class="error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="employeeEmail" class="form-label">üìß Employee Email</label>
                        <input type="email" id="employeeEmail" class="form-control" required placeholder="Enter employee email (name@astrolitetech.com)" minlength="8" maxlength="50">
                        <span id="employeeEmailError" class="error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="taskDescription" class="form-label">üìú Task Description</label>
                        <textarea id="taskDescription" class="form-control" required placeholder="Describe the task" minlength="5" maxlength="100"></textarea>
                        <span id="taskDescriptionError" class="error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="allocatedDate" class="form-label">üìÖ Allocated Date</label>
                        <input type="date" id="allocatedDate" class="form-control" required>
                        <span id="allocatedDateError" class="error-message"></span>
                    </div>
                    <div class="form-group">
                        <label for="deadline" class="form-label">üóìÔ∏è Deadline</label>
                        <input type="date" id="deadline" class="form-control" required>
                        <span id="deadlineError" class="error-message"></span>
                    </div>
                    <button type="submit" class="submit-btn">üöÄ Allocate Task</button>
                </form>
            </div>

            <!-- Allocated Tasks -->
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">üìã Allocated Tasks</h2>
                </div>
                <div class="task-grid" id="taskContainer">
                    <div class="empty-state">
                        <img src="https://cdn-icons-png.flaticon.com/512/4076/4076478.png" alt="No tasks">
                        <p>‚è≥ Loading tasks...</p>
                    </div>
                </div>
            </div>

            <!-- Work Updates -->
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">üìö Work Updates</h2>
                </div>
                <div class="work-history-grid" id="workHistoryContainer">
                    <div class="empty-state">
                        <img src="https://cdn-icons-png.flaticon.com/512/4076/4076478.png" alt="No history">
                        <p>üì≠ No work updates yet. Submit your first update to see it here.</p>
                    </div>
                </div>
            </div>

            <!-- Modal for Work Update Details -->
            <div class="modal" id="workUpdateModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">üîç Work Update Details</h2>
                        <button class="modal-close" onclick="closeModal()">√ó</button>
                    </div>
                    <div id="modalDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://51.20.37.61:3051/api';
        let allTasks = [];
        let validationTimeout;

        document.addEventListener("DOMContentLoaded", function() {
            const taskForm = document.getElementById('taskForm');
            const searchInput = document.getElementById('searchInput');
            const toggleFormBtn = document.getElementById('toggleFormBtn');
            const taskFormContainer = document.getElementById('taskFormContainer');
            const modal = document.getElementById('workUpdateModal');

            loadTasks();
            loadWorkUpdates();

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('allocatedDate').value = today;
            document.getElementById('allocatedDate').min = today;
            const maxAllocatedDate = new Date();
            maxAllocatedDate.setMonth(maxAllocatedDate.getMonth() + 3);
            document.getElementById('allocatedDate').max = maxAllocatedDate.toISOString().split('T')[0];
            updateDeadlineConstraints();

            function setupValidation() {
                const inputs = [
                    { id: 'taskName', errorId: 'taskNameError', validate: validateTaskName },
                    { id: 'employeeName', errorId: 'employeeNameError', validate: validateEmployeeName },
                    { id: 'employeeId', errorId: 'employeeIdError', validate: validateEmployeeId },
                    { id: 'employeeEmail', errorId: 'employeeEmailError', validate: validateEmployeeEmail },
                    { id: 'taskDescription', errorId: 'taskDescriptionError', validate: validateTaskDescription },
                    { id: 'allocatedDate', errorId: 'allocatedDateError', validate: validateAllocatedDate },
                    { id: 'deadline', errorId: 'deadlineError', validate: validateDeadline }
                ];

                inputs.forEach(({ id, errorId, validate }) => {
                    const input = document.getElementById(id);
                    input.addEventListener('input', () => {
                        clearTimeout(validationTimeout);
                        validationTimeout = setTimeout(() => validate(input, errorId), 500);
                    });
                    input.addEventListener('change', () => validate(input, errorId));
                });
            }

            setupValidation();

            toggleFormBtn.addEventListener('click', toggleForm);
            taskForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                if (validateForm()) {
                    if (confirm('üöÄ Allocate this task?')) {
                        await saveTask();
                    }
                } else {
                    alert('‚ùå Please correct the errors in the form before submitting.');
                }
            });

            searchInput.addEventListener('input', filterTasks);
            document.getElementById('allocatedDate').addEventListener('change', updateDeadlineConstraints);

            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
        });

        function toggleForm() {
            const taskFormContainer = document.getElementById('taskFormContainer');
            const toggleFormBtn = document.getElementById('toggleFormBtn');
            const isHidden = taskFormContainer.classList.contains('hidden');

            if (isHidden) {
                taskFormContainer.classList.remove('hidden');
                toggleFormBtn.innerHTML = '‚ùå Close Form';
            } else {
                taskFormContainer.classList.add('hidden');
                toggleFormBtn.innerHTML = 'üìã Allocate New Task';
                clearErrors();
            }
        }

        function updateDeadlineConstraints() {
            const allocatedDate = document.getElementById('allocatedDate').value;
            if (!allocatedDate) return;
            const deadlineInput = document.getElementById('deadline');
            deadlineInput.min = allocatedDate;
            const maxDeadline = new Date(allocatedDate);
            maxDeadline.setMonth(maxDeadline.getMonth() + 2);
            deadlineInput.max = maxDeadline.toISOString().split('T')[0];
            if (deadlineInput.value && deadlineInput.value < allocatedDate) {
                deadlineInput.value = '';
                validateDeadline(deadlineInput, 'deadlineError');
            }
        }

        function validateTaskName(input, errorId) {
            const error = document.getElementById(errorId);
            const value = input.value;
            const onlySpaces = /^\s*$/;
            const regex = /^[A-Za-z][A-Za-z0-9\s\-_]*[A-Za-z0-9]$/;
            const consecutiveSpaces = /\s{2,}/;
            const leadingTrailingSpaces = /^\s+|\s+$/;
            if (onlySpaces.test(value)) {
                error.textContent = '‚ùå Task name is required and cannot be only spaces.';
                error.style.display = 'block';
                input.value = '';
                return false;
            } else if (leadingTrailingSpaces.test(value)) {
                error.textContent = '‚ùå No leading or trailing spaces allowed.';
                error.style.display = 'block';
                return false;
            } else if (consecutiveSpaces.test(value)) {
                error.textContent = '‚ùå No consecutive spaces allowed.';
                error.style.display = 'block';
                return false;
            } else if (value.length < 3 || value.length > 40) {
                error.textContent = '‚ùå Task name must be 3-40 characters.';
                error.style.display = 'block';
                return false;
            } else if (!regex.test(value)) {
                error.textContent = '‚ùå Invalid task name: Must start with a letter, end with a letter or number, only letters, numbers, spaces, hyphens, underscores.';
                error.style.display = 'block';
                return false;
            } else {
                error.style.display = 'none';
                input.value = value.trim();
                return true;
            }
        }

        function validateEmployeeName(input, errorId) {
            const error = document.getElementById(errorId);
            const value = input.value;
            const onlySpaces = /^\s*$/;
            const regex = /^[A-Za-z]+(?:\.[A-Za-z]+)*(?: [A-Za-z]+)*(?:\.[A-Za-z]+){0,3}$/;
            const consecutiveSpaces = /\s{2,}/;
            const leadingTrailingSpaces = /^\s+|\s+$/;
            if (onlySpaces.test(value)) {
                error.textContent = '‚ùå Employee name is required and cannot be only spaces.';
                error.style.display = 'block';
                input.value = '';
                return false;
            } else if (leadingTrailingSpaces.test(value)) {
                error.textContent = '‚ùå No leading or trailing spaces allowed.';
                error.style.display = 'block';
                return false;
            } else if (consecutiveSpaces.test(value)) {
                error.textContent = '‚ùå No consecutive spaces allowed.';
                error.style.display = 'block';
                return false;
            } else if (value.length < 3 || value.length > 100) {
                error.textContent = '‚ùå Employee name must be 3-100 characters.';
                error.style.display = 'block';
                return false;
            } else if (!regex.test(value)) {
                error.textContent = '‚ùå Invalid employee name: Only letters, single spaces, and up to 3 dot-separated suffixes (e.g., John.M.Doe Smith.Jr).';
                error.style.display = 'block';
                return false;
            } else {
                error.style.display = 'none';
                input.value = value.trim();
                return true;
            }
        }

        function validateEmployeeId(input, errorId) {
            const error = document.getElementById(errorId);
            const value = input.value.trim().toUpperCase();
            const regex = /^[ATS]{3}0(?!000)[0-9]{3}$/;
            if (!value) {
                error.textContent = '‚ùå Employee ID is required.';
                error.style.display = 'block';
                input.value = '';
                return false;
            } else if (!regex.test(value)) {
                error.textContent = '‚ùå Invalid Employee ID: Must be in format ATS0XXX (e.g., ATS0001).';
                error.style.display = 'block';
                return false;
            } else {
                error.style.display = 'none';
                input.value = value;
                return true;
            }
        }

        function validateEmployeeEmail(input, errorId) {
            const error = document.getElementById(errorId);
            const value = input.value.trim();
            const onlySpaces = /^\s*$/;
            const regex = /^[a-zA-Z][a-zA-Z0-9._-]*[a-zA-Z0-9]@astrolitetech\.com$/;
            if (onlySpaces.test(value)) {
                error.textContent = '‚ùå Email is required and cannot be only spaces.';
                error.style.display = 'block';
                input.value = '';
                return false;
            } else if (!regex.test(value)) {
                error.textContent = '‚ùå Invalid email address: Must be in format name@astrolitetech.com.';
                error.style.display = 'block';
                return false;
            } else if (value.length < 8 || value.length > 50) {
                error.textContent = '‚ùå Email must be 8-50 characters.';
                error.style.display = 'block';
                return false;
            } else {
                error.style.display = 'none';
                input.value = value;
                return true;
            }
        }

        function validateTaskDescription(input, errorId) {
            const error = document.getElementById(errorId);
            const value = input.value;
            const onlySpaces = /^\s*$/;
            const regex = /^[A-Za-z][A-Za-z0-9\s,.]*[A-Za-z0-9]$/;
            const consecutiveSpaces = /\s{2,}/;
            const leadingTrailingSpaces = /^\s+|\s+$/;
            const invalidConsecutive = /(,{2,}|\.{2,}|,\s,|\.\s\.|,\s\.|\.\s,)/;
            if (onlySpaces.test(value)) {
                error.textContent = '‚ùå Task description is required and cannot be only spaces.';
                error.style.display = 'block';
                input.value = '';
                return false;
            } else if (leadingTrailingSpaces.test(value)) {
                error.textContent = '‚ùå No leading or trailing spaces allowed.';
                error.style.display = 'block';
                return false;
            } else if (consecutiveSpaces.test(value)) {
                error.textContent = '‚ùå No consecutive spaces allowed.';
                error.style.display = 'block';
                return false;
            } else if (value.length < 5 || value.length > 100) {
                error.textContent = '‚ùå Task description must be 5-100 characters.';
                error.style.display = 'block';
                return false;
            } else if (!regex.test(value)) {
                error.textContent = '‚ùå Invalid description: Must start with a letter, end with a letter or number, only letters, numbers, spaces, commas, periods.';
                error.style.display = 'block';
                return false;
            } else if (invalidConsecutive.test(value)) {
                error.textContent = '‚ùå No consecutive commas, periods, or invalid punctuation patterns.';
                error.style.display = 'block';
                return false;
            } else {
                error.style.display = 'none';
                input.value = value.trim();
                return true;
            }
        }

        function validateAllocatedDate(input, errorId) {
            const error = document.getElementById(errorId);
            const value = input.value;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const selectedDate = new Date(value);
            const maxDate = new Date();
            maxDate.setMonth(maxDate.getMonth() + 3);
            if (!value) {
                error.textContent = '‚ùå Allocated date is required.';
                error.style.display = 'block';
                return false;
            } else if (selectedDate < today) {
                error.textContent = '‚ùå Allocated date cannot be in the past.';
                error.style.display = 'block';
                return false;
            } else if (selectedDate > maxDate) {
                error.textContent = '‚ùå Allocated date cannot be more than 3 months from now.';
                error.style.display = 'block';
                return false;
            } else {
                error.style.display = 'none';
                return true;
            }
        }

        function validateDeadline(input, errorId) {
            const error = document.getElementById(errorId);
            const value = input.value;
            const allocatedDate = document.getElementById('allocatedDate').value;
            const selectedDate = new Date(value);
            const allocDate = new Date(allocatedDate);
            const maxDate = new Date(allocatedDate);
            maxDate.setMonth(maxDate.getMonth() + 2);
            if (!value) {
                error.textContent = '‚ùå Deadline is required.';
                error.style.display = 'block';
                return false;
            } else if (selectedDate < allocDate) {
                error.textContent = '‚ùå Deadline must be on or after allocated date.';
                error.style.display = 'block';
                return false;
            } else if (selectedDate > maxDate) {
                error.textContent = '‚ùå Deadline cannot be more than 2 months from allocated date.';
                error.style.display = 'block';
                return false;
            } else {
                error.style.display = 'none';
                return true;
            }
        }

        function validateForm() {
            const inputs = [
                { id: 'taskName', validate: validateTaskName },
                { id: 'employeeName', validate: validateEmployeeName },
                { id: 'employeeId', validate: validateEmployeeId },
                { id: 'employeeEmail', validate: validateEmployeeEmail },
                { id: 'taskDescription', validate: validateTaskDescription },
                { id: 'allocatedDate', validate: validateAllocatedDate },
                { id: 'deadline', validate: validateDeadline }
            ];
            return inputs.every(({ id, validate }) => validate(document.getElementById(id), `${id}Error`));
        }

        function clearErrors() {
            const errors = document.querySelectorAll('.error-message');
            errors.forEach(error => {
                error.style.display = 'none';
                error.textContent = '';
            });
        }

        async function saveTask() {
            const taskData = {
                taskName: document.getElementById('taskName').value.trim(),
                employeeName: document.getElementById('employeeName').value.trim(),
                employeeId: document.getElementById('employeeId').value.trim().toUpperCase(),
                email: document.getElementById('employeeEmail').value.trim(),
                taskDescription: document.getElementById('taskDescription').value.trim(),
                allocatedDate: document.getElementById('allocatedDate').value,
                deadline: document.getElementById('deadline').value,
                status: 'assigned'
            };

            try {
                const response = await fetch(`${API_BASE_URL}/tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData)
                });

                if (!response.ok) {
                    let errorMessage = '‚ùå Failed to save task';
                    try {
                        const errorData = await response.json();
                        errorMessage = `‚ùå ${errorData.error || errorMessage}`;
                    } catch (jsonErr) {
                        errorMessage = `‚ùå Server error: ${response.status}`;
                    }
                    throw new Error(errorMessage);
                }

                document.getElementById('taskForm').reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('allocatedDate').value = today;
                updateDeadlineConstraints();
                clearErrors();
                await loadTasks();
                alert('üéâ Task allocated successfully!');
                toggleForm();
            } catch (err) {
                console.error('Error saving task:', err);
                alert(`‚ùå Error saving task: ${err.message}`);
            }
        }

        async function loadTasks() {
            const taskContainer = document.getElementById('taskContainer');
            taskContainer.innerHTML = '';

            try {
                const response = await fetch(`${API_BASE_URL}/tasks`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                allTasks = await response.json();

                filterTasks();
            } catch (err) {
                console.error('Error loading tasks:', err);
                taskContainer.innerHTML = `
                    <div class="empty-state">
                        <img src="https://cdn-icons-png.flaticon.com/512/4076/4076478.png" alt="Error">
                        <p>‚ùå Error loading tasks: ${err.message}</p>
                    </div>
                `;
            }
        }

        function filterTasks() {
            const taskContainer = document.getElementById('taskContainer');
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();

            const filteredTasks = allTasks.filter(task => {
                return (
                    task.task_name.toLowerCase().includes(searchTerm) ||
                    task.employee_name.toLowerCase().includes(searchTerm) ||
                    task.employee_id.toLowerCase().includes(searchTerm) ||
                    (task.email && task.email.toLowerCase().includes(searchTerm))
                );
            });

            taskContainer.innerHTML = '';

            if (filteredTasks.length === 0) {
                taskContainer.innerHTML = `
                    <div class="empty-state">
                        <img src="https://cdn-icons-png.flaticon.com/512/4076/4076478.png" alt="No tasks">
                        <p>üì≠ No tasks match your criteria.</p>
                    </div>
                `;
                return;
            }

            filteredTasks.forEach(task => {
                if (!task) return;
                const taskCard = document.createElement('div');
                taskCard.className = 'task-card';
                const names = task.employee_name ? task.employee_name.split(' ') : ['?'];
                const initials = names.map(n => n[0]).join('').toUpperCase().substring(0, 2);
                const status = task.status || 'assigned';
                const statusEmoji = status === 'inprocess' ? 'üîÑ' : status === 'completed' ? '‚úÖ' : 'üìå';
                taskCard.innerHTML = `
                    <div class="status-badge status-${status}">${statusEmoji} ${status.toUpperCase()}</div>
                    <div class="employee-info">
                        <div class="employee-avatar">${initials}</div>
                        <div>
                            <div class="employee-name">${task.employee_name || 'Unknown'}</div>
                            <div class="employee-id">üÜî ${task.employee_id || 'ID Not Provided'}</div>
                            <div class="employee-email">üìß ${task.email || 'Email Not Provided'}</div>
                        </div>
                    </div>
                    <h3 class="task-title">üìã ${task.task_name || 'Untitled Task'}</h3>
                    <textarea class="task-description" readonly>${task.task_description || 'No description provided'}</textarea>
                    <div class="task-dates">
                        <div class="date-item">üìÖ <span>Allocated: ${task.allocated_date ? formatDate(task.allocated_date) : 'Not set'}</span></div>
                        <div class="date-item">üóìÔ∏è <span>Deadline: ${task.deadline ? formatDate(task.deadline) : 'Not set'}</span></div>
                    </div>
                    <div class="task-actions">
                        <button class="btn btn-primary" onclick="viewTaskDetails('${task.id}')"> Details</button>
                        <button class="btn btn-outline" onclick="downloadTask('${task.id}')">üì• Download</button>
                    </div>
                `;
                taskContainer.appendChild(taskCard);
            });
        }

        async function loadWorkUpdates() {
            const historyContainer = document.getElementById('workHistoryContainer');
            historyContainer.innerHTML = '';

            try {
                const response = await fetch(`${API_BASE_URL}/task-history`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const workHistory = await response.json();

                if (workHistory.length === 0) {
                    historyContainer.innerHTML = `
                        <div class="empty-state">
                            <img src="https://cdn-icons-png.flaticon.com/512/4076/4076478.png" alt="No history">
                            <p>üì≠ No work updates yet. Submit your first update to see it here.</p>
                        </div>
                    `;
                    return;
                }

                historyContainer.innerHTML = '';

                workHistory.forEach(item => {
                    const historyCard = document.createElement('div');
                    historyCard.className = 'work-history-card';
                    let statusClass = '';
                    let statusText = '';
                    let statusEmoji = '';
                    if (item.task_status === 'inprocess') {
                        statusClass = 'status-inprocess';
                        statusText = 'In Process';
                        statusEmoji = 'üîÑ';
                    } else if (item.task_status === 'completed') {
                        statusClass = 'status-completed';
                        statusText = 'Completed';
                        statusEmoji = '‚úÖ';
                    } else {
                        statusClass = 'status-assigned';
                        statusText = 'Unknown';
                        statusEmoji = 'üìå';
                    }

                    historyCard.innerHTML = `
                        <div class="status-badge ${statusClass}">${statusEmoji} ${statusText}</div>
                        <h3 class="task-title">üìö ${item.task_name || 'Untitled Work Item'}</h3>
                        <div class="task-info">
                            <p><strong>üë§ Employee:</strong> ${item.employee_name || 'Unknown'}</p>
                        </div>
<div class="task-actions" style="display: flex; justify-content: left; align-items: center; margin-top: 1rem;">
    <button 
        class="btn1 btn-primary view-details-btn" 
        onclick="showDetails('${item.id}', '${encodeURIComponent(item.task_name || 'Untitled Work Item')}', '${encodeURIComponent(item.employee_name || 'Unknown')}', '${item.employee_id || 'No ID'}', '${encodeURIComponent(item.email || 'No email')}', '${encodeURIComponent(item.description || 'No description provided')}', '${statusText}', '${item.allocated_time ? formatDate(item.allocated_time) : 'Not set'}', ${item.has_file})"
        style="background: none; border: none; font-size: 18px; color: blue; cursor: pointer;"
    >
        View Details
    </button>
</div>


                    `;

                    historyContainer.appendChild(historyCard);
                });
            } catch (err) {
                console.error('Error loading work updates:', err);
                historyContainer.innerHTML = `
                    <div class="empty-state">
                        <img src="https://cdn-icons-png.flaticon.com/512/4076/4076478.png" alt="Error">
                        <p>‚ùå Error loading work history: ${err.message}</p>
                    </div>
                `;
            }
        }

        function showDetails(id, taskName, employeeName, employeeId, email, description, status, submitted, hasFile) {
            const modal = document.getElementById('workUpdateModal');
            const modalDetails = document.getElementById('modalDetails');
            const statusEmoji = status === 'In Process' ? 'üîÑ' : status === 'Completed' ? '‚úÖ' : 'üìå';
              let statusColor = '#d3d3d3';
    if (status === 'In Process') statusColor = '#e5f6ff';  
    else if (status === 'Completed') statusColor = '#d4edda'; 
    else if (status === 'Pending') statusColor = '#f8d7da';
            modalDetails.innerHTML = `
                <p><strong>üìö Task Name:</strong> ${decodeURIComponent(taskName)}</p>
                <p><strong>üë§ Employee Name:</strong> ${decodeURIComponent(employeeName)}</p>
                <p><strong>üÜî Employee ID:</strong> ${employeeId}</p>
                <p><strong>üìß Email:</strong> ${decodeURIComponent(email)}</p>
        <p><strong>üîÑ Status:</strong> 
            <span style="background-color: ${statusColor}; padding: 4px 8px; border-radius: 6px; font-weight: 600;">
                ${statusEmoji} ${status}
            </span>
        </p>                <p><strong>üìÖ Submitted:</strong> ${submitted}</p>
                <p style="margin-top: 1rem; word-break: break-word;"><strong>üìú Description:</strong><br><div style="margin-left: 1.5rem; margin-top: 0.5rem; white-space: pre-wrap;">${decodeURIComponent(description)}</div></p>
 <p style="margin-top: 1rem;">
            <strong>üìé Uploaded Document:</strong><br>
            <div style="margin-left: 1.5rem; margin-top: 0.5rem;">
                ${hasFile 
                    ? `<button class="btn btn-outline" onclick="downloadHistoryFile('${id}', '${decodeURIComponent(taskName).replace(/[^a-z0-9]/gi, '_')}')">üì• Download File</button>`
                    : '<span class="no-file">üì≠ No file attached</span>'
                }
            </div>
        </p>
            `;

            modal.style.display = 'flex';
        }

        function closeModal() {
            const modal = document.getElementById('workUpdateModal');
            modal.style.display = 'none';
        }

        async function downloadHistoryFile(id, taskName) {
            try {
                const response = await fetch(`${API_BASE_URL}/task-history/${id}/file`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const contentType = response.headers.get('content-type');
                let fileExtension = '.bin';

                if (contentType.includes('pdf')) {
                    fileExtension = '.pdf';
                } else if (contentType.includes('msword')) {
                    fileExtension = '.doc';
                } else if (contentType.includes('wordprocessingml.document')) {
                    fileExtension = '.docx';
                } else if (contentType.includes('jpeg')) {
                    fileExtension = '.jpg';
                } else if (contentType.includes('png')) {
                    fileExtension = '.png';
                } else if (contentType.includes('text/plain')) {
                    fileExtension = '.txt';
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${taskName}${fileExtension}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (err) {
                console.error('Error downloading file:', err);
                alert(`‚ùå Error downloading file: ${err.message}`);
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'Invalid date';
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            try {
                return new Date(dateString).toLocaleDateString('en-US', options);
            } catch (e) {
                return 'Invalid date';
            }
        }

        function viewTaskDetails(taskId) {
            try {
                const task = allTasks.find(task => task.id === taskId);
                if (!task) {
                    throw new Error('Task not found');
                }
                const statusEmoji = task.status === 'inprocess' ? 'üîÑ' : task.status === 'completed' ? '‚úÖ' : 'üìå';
                alert(`üìã Task Details:\n\nName: ${task.task_name || 'Untitled Task'}\nEmployee: ${task.employee_name || 'Unknown'}\nID: ${task.employee_id || 'Not Provided'}\nEmail: ${task.email || 'Not Provided'}\nStatus: ${statusEmoji} ${task.status || 'Unknown'}\n\nDescription:\n${task.task_description || 'No description provided'}\n\nAllocated: ${task.allocated_date ? formatDate(task.allocated_date) : 'Not set'}\nDeadline: ${task.deadline ? formatDate(task.deadline) : 'Not set'}`);
            } catch (err) {
                console.error('Error fetching task details:', err);
                alert(`‚ùå Error fetching task details: ${err.message}`);
            }
        }

        async function downloadTask(taskId) {
            try {
                const task = allTasks.find(task => task.id === taskId);
                if (!task) {
                    throw new Error('Task not found');
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(16);
                doc.text(' Task Details', 105, 15, { align: 'center' });

                doc.setFontSize(12);
                doc.text(` Task Name: ${task.task_name || 'Untitled Task'}`, 14, 25);
                doc.text(` Employee: ${task.employee_name || 'Unknown'} (${task.employee_id || 'Not Provided'})`, 14, 35);
                doc.text(` Email: ${task.email || 'Not Provided'}`, 14, 45);
                doc.text(` Status: ${task.status || 'Unknown'}`, 14, 55);

                doc.text(' Description:', 14, 65);
                const splitDescription = doc.splitTextToSize(task.task_description || 'No description provided', 180);
                doc.text(splitDescription, 14, 75);

                doc.text(` Allocated Date: ${task.allocated_date ? formatDate(task.allocated_date) : 'Not set'}`, 14, 95);
                doc.text(` Deadline: ${task.deadline ? formatDate(task.deadline) : 'Not set'}`, 14, 105);

                doc.save(`task_${(task.task_name || 'untitled').replace(/[^a-z0-9]/gi, '_')}.pdf`);
            } catch (err) {
                console.error('Error downloading task:', err);
                alert(`‚ùå Error downloading task: ${err.message}`);
            }
        }
    </script>
</body>
</html>